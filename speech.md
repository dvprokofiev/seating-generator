# Создание веб-сайта для нахождения оптимальной рассадки учеников в классе

Даниил Прокофьев <d@dvprokofiev.ru>

## Вступление. Пределы человеческого мозга

Идея создать данное чудо появилось у меня в тот момент, когда я подумал, как сложно может быть рассадить учеников в классе так, чтобы никто никому не мешал, никто никого не отвлекал, друзья сидели вместе, а я со своим испорченным зрением сидел не дальше третьей парты на среднем ряду.

Но человеку доверять такую задачу - неэффективно, ведь человеческий мозг способен в момент времени удерживать не более $7 \pm 2$ факторов (это так называемое число Миллера). В то время как при рассадке класса в 30 человек со своими предпочтениями, медицинскими ограничениями, друзьями... Это сотни перекрестных ограничений, которые учитель не может учесть все просто потому, что он человек. Не будем его за это винить.

Поэтому разумно будет получить эту задачу компьютеру, для которого держать и даже более 100 факторов для нахождения рассадки - не проблема.

## Постановка задачи

> Разработать веб-сайт, генерирующий оптимальную рассадку с учетом данных ограничений и предпочтений

#### Какие могут ограничения и предпочтения?

Мне не хотелось ограничивать свободу учителя и усложнять себе жизнь в случае, если когда-нибудь понадобиться расширить функционал генератора, вводя рассадку по оценкам или среднему баллу, или по росту. Поэтому я выделил четыре типа ограничений:

- Ограничения, связанные с **медицинскими предписаниями** (например, ученик должен сидеть за первой партой согласно предписанию врача)
- Ограничения, связанные с **нежелательным соседством** двух учеников (например, двое учеников враждуют)
- Предпочтения по **рядам и партам** (например, ученик хочет сидеть на первой парте)
- Предпочтения учеников по **соседству** (например, двое друзей хотят сидеть вместе)

Задача относится к NP-полным задачам. (задачи, для которого не существует известного алгоритма, работающего за полиноминальное время, но правильность ответа которой можно проверить за полиноминальное время). Значит, для решения этой задачи будет хорошо использовать эвристику - алгоритм решения задачи, включающий практический метод, не являющийся гарантированно точным или оптимальным, но достаточный для решения поставленной задачи.

## Жадность

Для решения задачи можно попробовать использовать алгоритм, который мне кажется самым удобным при ручной рассадке учеников. В чем его суть7

- Выставим учеников в очередь. Сначала поставим тех, кто имеет медицинские, потом тех, кто имеет просто предпочтения по ряду или парте, потом тех, кому вместе сидеть нельзя и, наконец друзей (порядок предпочтений можно менять)

- Возьмем одного ученика из очереди и посадим его на лучшее в данный момент для него место

Казалось бы, что может пойти не так? Но нет. Посаженный на первых порах неудачно, ученик будет мешать возникновению оптимальной рассадки. Алгоритм может и найдет какое-то решение, и что-то в нем будет хорошего, но это будет локальный максимум, а не глобальный, который мы ищем.

## ОООООТЖЫЫЫЫЫГ

Процесс отжига в физике — это когда металл сначала сильно нагревают, а потом медленно снижают его температуру. Идея в том, чтобы выстроить атомы в кристаллическую решётку и сформировать как можно больше таких устойчивых решёток в металле. Если всё сделать правильно, у металла снижается твёрдость, убираются внутренние напряжения и металл становится более однородным — так его легче обрабатывать.

Если выписать из процесса отжига ключевые мысли и точки, то получим интересное:

- есть система, которая находится не в нужном для нас состоянии;
- есть процессы, которые могут протекать в этой системе;
- есть параметр (температура), благодаря которому система сама может отрегулировать себя и прийти в нужное состояние;
- и есть конечное значение (температуры), по достижении которого система считается максимально близкой к нужному состоянию.

Однако сам алгоритм довольно медленный, так как для получения оптимального результата требует медленного охлаждения. А при быстром охлаждении алгоритм все так же может застревать в локальном максимуме.

## Генетический алгоритм

Обратимся к матушке природе. Будем развивать не одно решение, а целую популяцию, и будем производить над ней такие операции как естественный отбор, скрещивание, случайная мутация.

Однако в данном случае эволюция получается слепая. То есть мутации часты, но случайны, и на то, чтобы переместить двух учеников местами, алгоритму может потребоваться очень много поколений, что не есть хорошо.

## Меметический алгоритм

Поэтому в дополнение к генетике будем к каждой из лучшей особей и с шансом 5% к случайной особи применять локальный поиск.

#### Что такое локальный поиск?

В моей реализации локальный поиск N раз берет двух случайных учеников и меняет их местами. Если результат стал лучше, то мы оставляем их так. Если нет, то возвращаем на место.

Несмотря на то, что алгоритм примитивный, его внедрение помогло снизить количество поколений, необходимых для получения оптимальной рассадки и тем самым снизить время выполнения.

## Как хранить рассадки в памяти?

... все на слайде ...

## Как работает меметический алгоритм?

... импровизация по комментариям в коде, которые будут добавлены ...

## Фитнес функция: как оценить рассадку?

Оценка рассадки есть сумма удовлетворенности каждого из учеников. Стоит заметить, что для проверки предпотчений (медицинских и просто по рядам и партам) используется такая технология: при запуске алгоритма мы генерируем массив, который для каждого ученика и его возможного места сразу заполняет количество баллов, которые он может получить. Это позволяет нам быстро (за константу) считать, насколько учтены данные предпочтения.

## Как работает проверка предпочтений?

Каждая функция проверки того или иного критерия возвращает нормализованное значение от 0 до 1. Оно считается так:

утченность_предпочтения / максимум

Затем значение такой функции умножается на вес - один из параметров алгоритма, который задается самим пользователем.

## Веса фитнес функции

Необходимо дать пользователю возможность выбрать, что для него важнее: чтобы друзья сидели вместе, или чтобы те, кто хотят сидеть на первой парте сидели на первой парте? Поэтому были введены веса: числа от 0 до 1, на которые домножаются значения функций проверки предпочтений. Весов столько же, сколько и видов предпочтений + 5-й, который влияет на заполняемость класса (то есть, насколько учеников при рассадке должно тянуть вперед, к доске)

## Почему выбран язык программирования Go?

...

Стоит упомянуть, что параллелизм действительно стал довольно полезной вещью. И скорость языка Go позволяет мне гонять все это на сервере за 80 рублей в месяц! А Python так никогда бы не смог)

...

## "Архитектура"

Вычисление алгоритма лежит на отдельном сервере, а не на машине пользователя. Почему? Да потому что я посмотрел на компьютеры в нашей школе, и хоть многие старые уже были заменены на новые, более производительные, на столах учителей остались стоять динозавры, которые еле переваривают открытие тяжело PDF документа учебника.

Фронтенд в таком случае, то есть сам веб-сайт только отправляет запрос на сервер и получая его, визуализирует, а затем позволяет удобно работать с результатами работы алгоритмы: сохранять и экспортировать в PDF рассадки.

## Дружественный интерфейс...

Стояла задача разработать все понятный и удобный интерфейс. Нужно было отделить возможность сохранять классы, выбирать их в генераторе и изменять их параметры друг от друга, и еще добавить много других полезных функций, о которых я сейчас не вспомню, но они точно улучшили пользовательский опыт!

Перед нами главный экран: на нем можно выбрать класс и загрузить его в генератор, открыть историю сохраненных рассадок и редактировать его.

--

Перед нами редактор класса. здесь можно вводить все вышеперечисленные ограничения. Если нажать на значок карты или сердца, то откроется мини диалоговое окно с визуализацией класса, где тыкая по рядам и партам можно прописывать ученикам соответственно ряды и парты медицинские и обычные.

--

Интерфейс генератора. Слайдеры для настройки тех самых весов, визуализация класса с тепловой картой учтенности предпочтений каждого ученика.

--

Архив рассадок. И возможность так же открыть визуализацию рассадки в мини диалоговом окне, а в последствии экспортировать в PDF.

## Что использовано

Ну, тут действительно надо посмотреть на package.json и поводить пальцем.

## Структура файлов

Главные здесь те файлы, что заканчиваются на .Vue. Это и есть те самые компоненты, кусочки, страницы интерфейса. Остальное вторично

## Почему все запускается одной командой или CI/CD

Была настроена очень удобная система сборки генератора как его отдельных составных частей, с помощью Docker и GitHub Actions. Дальше на слайде все описано. При любом изменении файла проекта запускается автоматическая компиляция и сборка. Поэтому в GHRC всегда лежит свежая версия контейнера.

## Всемирная паутина

За смешные деньги я купил себе домен seating-generator.ru и VPS на Cloud.ru (использован их бесплатный тариф, где надо платить только за IP).

Раньше в этой схеме фигурировал Cloudflare (защита от DDoS атак), однако от него пришлось отказаться из-за блокировок, которым он был подвержен на территории РФ.

## Лицензирование

...
